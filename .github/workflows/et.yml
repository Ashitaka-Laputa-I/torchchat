name: Compile main

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  run-tinystories:
    strategy:
      matrix:
        runner: [macos-16]
    runs-on: ${{matrix.runner}}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Print machine info
        run: |
          uname -a
          if [ $(uname -s) == Darwin ]; then
            sysctl machdep.cpu.brand_string
            sysctl machdep.cpu.core_count
          fi
      - name: Install requirements
        run: |
          echo "Intalling pip packages"
          pip install wheel
          pip install cmake
          pip install ninja
          pip install zstd
          pip install -r requirements.txt

          export LLAMA_FAST_DIR=${PWD}
          ./scripts/install_et.sh
      - name: Download checkpoints
        run: |
          mkdir -p checkpoints/stories15M
          pushd checkpoints/stories15M
          wget https://huggingface.co/karpathy/tinyllamas/resolve/main/stories15M.pt
          wget https://github.com/karpathy/llama2.c/raw/master/tokenizer.model
          wget https://github.com/karpathy/llama2.c/raw/master/tokenizer.bin
          popd
      - name: Run inference
        run: |
          export CHECKPOINT_PATH=${PWD}/checkpoints/stories15M
          export MODEL_NAME=stories15M

          python generate.py --checkpoint-path ${CHECKPOINT_PATH}/stories15M.pt --temperature 0 --prompt "Once upon a time" > ${PWD}/output_eager
          cat ${PWD}/output_eager

          python export.py --checkpoint-path ${CHECKPOINT_PATH}/stories15M.pt --output-pte-path ${PWD}/stories15M.pte
          python generate.py --checkpoint-path ${CHECKPOINT_PATH}/stories15M.pt --temperature 0 --prompt "Once upon a time" --pte-path ${PWD}/stories15M.pte  > ${PWD}/output_et
          cat ${PWD}/output_et

          ./build/cmake-out/runner_et run ${PWD}/stories15M.pte -z ${CHECKPOINT_PATH}/tokenizer.bin -i "Once upon a time" > ${PWD}/output_runner_et

          echo "eager out:"
          cat ${PWD}/output_eager

          echo "et out:"
          cat ${PWD}/output_et

          echo "runner-et out:"
          cat ${PWD}/output_runner_et

          echo "Tests complete."
